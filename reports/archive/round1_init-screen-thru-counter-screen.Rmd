---
title: "Sandbox Round 1"
author: "Abby Coleman"
date: "`r Sys.Date()`"
geometry: margin = 2cm
output: 
  pdf_document:
    toc: TRUE
    
header-includes:
  - \usepackage{titling}
  - \pretitle{\begin{center}
  - \includegraphics[width=1in,height=1in]{Ellison Medical Institute Logo_Bronze.png}\LARGE\\}
  - \posttitle{\end{center}}
  - \usepackage{fancyhdr}
  - \pagestyle{fancy}
  - \fancyhead[C]{Sandbox Round 1}
  - \fancyhead[L]{\includegraphics[width=0.5in]{Ellison Medical Institute Logo_Bronze.png}}
  - \fancyfoot[L]{Ellison Medical Institute}
  - \setlength{\headheight}{30.10677pt}
---

```{r setup, include = FALSE}

library(here)
library(pander)
library(ggplot2)
library(ggbeeswarm)
library(tidyverse)
library(patchwork)
library(ggnewscale)
library(conflicted)
library(kableExtra)
library(testthat)
library(devtools)
library(viridis)
library(drc)
library(usethis)
library(paletteer)
library(kableExtra)
library(pracma)

#TODO: load these in a function
source(here("R", "plot_plate_zfactors.R"))
source(here("R", "plot_zfactor_outliers.R"))
source(here("R", "plot_platemap.R"))
source(here("R", "print_platemap.R"))
source(here("R", "functions.R"))

knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      fig.align = "center")

#resolve conflicts
conflicts_prefer(dplyr::filter(),
                  stats::gaussian(),
                  dplyr::select())
```


\newpage

# Introduction

The following report analyzes "Round 1" of the screening data produced for EMI's collaboration with SandboxAQ.

Colloquially referred to as the “Sandbox” project at EMI, this project is a collaboration between EMILA and SandboxAQ to discover better drug candidates targeting the Androgen Receptor (AR) by using Generative AI and traditional biological assays.  

Most AR drugs compete with the AR ligand testosterone at the Ligand Binding Domain (LBD) and as a result resistance arises from the mutation of or complete loss of function of the LBD.

The DNA Binding Domain (DBD) is crucial for AR dimerization and is present in all ARs which makes the DBD a possible high value target for AR drug discovery.   The difficulty with the DBD as a target is two-fold.  Firstly, the DBD is structurally disordered, except for two zinc fingers.  Secondly, the DBD is highly conserved across nuclear receptors where a short C-terminal extension confers specificity.

 The Sandbox project would like to leverage the Generative AI technology of SandboxAQ to produce a list of novel molecules and to conduct in-silico screens of millions of commercially available compounds.  The top hits of the in-silico screens would then be screened at EMILA in traditional biological assays.  EMILA would screen to identify hits and then conduct counter screens to eliminated AR-LBD hits.  Hits would then be confirmed via dose response curves.  Hits would then be tested in drug resistant AR cell lines.


The results herein consist of the "screen and test in vitro" portion of the overall workflow of EMI's collaboration with SandboxAQ, pictured below.

```{r graphic1, out.width = "100%"}
knitr::include_graphics(here("images", "overall_workflow.png"))
```

\newpage

More specifically, this report analyzes assays from the target and counter screen sections of the graphic below. Lab researchers led by Mickey Huang used luciferase assays to screen 294 compounds generated by SandboxAQ in silico. Then, they used this same assay to generate dose response curves and conduct an AR Polar Binding Counter Screen. Specificity assays are being optimized as of 4/24/2025.

```{r graphic2, out.width = "100%"}
knitr::include_graphics(here("images", "pilot_sankey.png"))
```

\newpage

# Overall Summary

```{r data_load, message = FALSE}
ctrl0 <<- "DMSO"
ctrl100 <<- "R1881"

alldf <- readRDS(here("data", "well_level_data.RDS"))
stats <- readRDS(here("data", "plate_level_stats.RDS")) %>%
  #extrapolated ic50 is talking about relative ic50
  mutate(good_rel_ic50 = case_when(extrapolated_rel_ec50 == FALSE & rse < rse_cutoff & !is.nan(rel_ec50) ~ "good",
                              TRUE ~ "bad"),
         good_abs_ic50 = case_when(extrapolated_abs_ec50 == FALSE & rse < rse_cutoff & !is.nan(abs_ec50) ~ "good",
                              TRUE ~ "bad"),)
#TODO: put this in data_clean, make it not insane looking, document further
#make a nice version of the MCULE-XXXXXXX labels for plots
all_cois <- unique(alldf$coi)
ctrls <- c(ctrl0, ctrl100, "Enzalutamide", all_cois[grepl("VPC|VCP", all_cois)])
ordered_cois <- c(ctrls, sort(str_remove(all_cois[!(all_cois %in% ctrls)], "MCULE-")))
alldf <- alldf %>%
  mutate(
    coi_lab = str_remove(coi, "MCULE-"),
    coi_lab = factor(coi_lab, levels = ordered_cois)
  )
#TODO: the ctrl column now includes designation of "control compounds" for enz and vpc-- make sure to make corresponding edits in ur code (to avoid redundancy)
#TODO: add coi_lab to data_clean script

best_ec50_drc <- stats %>% 
  filter(good_rel_ic50 == "good") %>% 
  filter(good_abs_ic50 == "good") %>%
  filter(assay_type == "Dose Response Curve") %>% 
  filter(ctrl == "sample") %>%
  select(experiment_id, experiment_name, coi, abs_ec50, rel_ec50) %>%
  arrange(coi, experiment_id)
# names(best_ec50_drc) <- c("Experiment ID", "Experiment Name", "Compound", "Absolute EC50", "Relative EC50")

best_ec50_pb <- stats %>% 
  filter(good_rel_ic50 == "good") %>% 
  filter(good_abs_ic50 == "good") %>%
  filter(assay_type == "Polar Binding") %>% 
  filter(ctrl == "sample") %>%
  select(experiment_id, experiment_name, coi, abs_ec50, rel_ec50) %>%
  arrange(coi, experiment_id)
# names(best_ec50_drc) <- c("Experiment ID", "Experiment Name", "Compound", "Absolute EC50", "Relative EC50")

```

* Initial Screen
    * In total, `r nrow(unique(alldf[grepl("SD hit", alldf$scr_hit), "coi"]))` had an average percent control lower than that of the 100% control - 3SD. This represents `r round(nrow(unique(alldf[grepl("SD hit", alldf$scr_hit), "coi"]))/nrow(unique(alldf[alldf$assay_type == "Screen" & alldf$ctrl == "sample", "coi"]))*100, 2)`% of the total number of compounds tested.
* Viability Dose Response
    * `r nrow(unique(alldf[alldf$assay_type == "Dose Response Curve" & alldf$ctrl == "sample", "coi"]))` compounds were advanced to the next round of screening using interim criteria. 
    * `r nrow(best_ec50_drc)` compounds produced reliable relative and absolute EC50s (not extrapolated, RSE's below quantile outlier cutoff). In the table below, they are sorted by Absolute EC50.

```{r drc_ec50_tab}
fortab <- best_ec50_drc %>%
  select(-c(experiment_id, rel_ec50))
names(fortab) <- c("Experiment Name", "Compound", "Absolute EC50")
kable(fortab, digits = 2)
```

* Polar Binding Dose Response
    * `r nrow(unique(alldf[alldf$assay_type == "Polar Binding" & alldf$ctrl == "sample", "coi"]))` compounds were included in the polar binding assay. 
    * `r nrow(best_ec50_pb)` compounds produced reliable relative and absolute EC50s (not extrapolated, RSE's below quantile outlier cutoff). In the table below, they are sorted by Absolute EC50.

```{r pb_ec50_tab}
for_tab <- best_ec50_pb %>%
  select(-c(experiment_id, rel_ec50))
names(for_tab) <- c("Experiment Name", "Compound", "Absolute EC50")
kable(for_tab, digits = 2)
```

\newpage

# Quality Control

## Overall Summary

question: should we be calling these "cutoffs"?

We collect these assay quality control statistics:

* Z'Factor
    * measures separation between high and low controls
    * cutoff: < 0
* Average Intra-Assay %CV, or Average%CV
    * measures overall assay variation
    * cutoff: > quantile outlier bound
  

```{r qc_tab1}
qctab <- alldf %>%
  mutate(
    plate_zprime = cell_spec(
      round(plate_zprime, 3),
      color = case_when(plate_zprime < 0 ~ "white", TRUE ~ "black"),
      background = case_when(plate_zprime < 0 ~ "#A96D4B", TRUE ~ "white")
    ),
    summary_cv = cell_spec(
      round(summary_cv, 3),
      color = case_when(summary_cv > cv_cutoff ~ "white", TRUE ~ "black"),
      background = case_when(summary_cv > cv_cutoff ~ "#A96D4B", TRUE ~ "white")
    )
  ) %>%
  select(experiment_id,
         data.plate_id,
         experiment_type,
         assay_type,
         start_date,
         plate_zprime,
         summary_cv) %>%
  distinct() %>%
  arrange(assay_type, experiment_id)
names(qctab) <- c(
  "Experiment ID",
  "Plate ID",
  "Experiment Type",
  "Assay Type",
  "Start Date",
  "Plate Z'Factor",
  "Summary Percent CV"
)
kable(qctab, digits = 3, booktabs = TRUE)
```

\newpage

## Z'Factor

This QC statistic measures the separation band between high and low controls. 

```{r graphic3, out.width = "100%"}
knitr::include_graphics(here("images", "zfactor_explainer.png"))
```

Z'Factor is calculated with the following formula:



A Z'Factor above 0 is considered sufficient at EMI.
 
[Further reading.](https://pubmed.ncbi.nlm.nih.gov/10838414/)

\newpage
 
```{r qcbox, out.width = "80%"}
print(plot_plate_zfactors(alldf))
```

The above plot shows Z'factors calculated for each plate. There are `r nrow(unique(alldf[alldf$plate_zprime < 0, "data.plate_id"]))` plates with Z'factors less than 0. These plates are numbered: `r paste(unique(alldf[alldf$plate_zprime < 0, "data.plate_id"])[[1]], collapse = ", ")`.

```{r zprime, fig.height = 6, fig.width = 8}
print(plot_zfactor_outliers(alldf))
```

These plots show that high variability in 100% control conditions are likely the cause for the low Z'Factors in this plate. 

Also of note: many molecules generated by the SandboxAQ algorithm and in silico screen produce RLU higher than the 100% control condition.

\newpage

For further examination, below are plate heat maps for each plate with a Z'Factor less than 0.

```{r platemaps, results = "asis", width.out = "30%"}
platemap_df <- alldf %>%
  #filter for only plates with weird zprime factors
  #TODO: designate a parameter for this report to standardize upper bound for plate z'factor
  #(eventually, we'll want to have somewhere easy we can plug in this "20")
  filter(plate_zprime < 0 | plate_zprime > 20) %>%
  mutate(
    #get rows and columns from well id
    well = str_extract(data.well_id, "[:alpha:][:digit:]{2}"),
    col = str_extract(well, "[:digit:]{2}"),
    row = str_extract(well, "[:alpha:]")
  ) %>%
  select(experiment_id, col, row, assay_type, data.result, summary_zfactor, coi, data.plate_id) %>%
  distinct()

platemap_df <- platemap_df %>%
  mutate(
    #remove molecule numbers from sample wells
    #if we kept those in, the platemap would look too cluttered
    #for the purposes of the platemap, we only really care about the differences between samples and controls, anyways
    nice_coi = str_remove(coi, "\\-[:digit:]+"),
    #make row and col columns factors
    row = factor(row, levels = sort(unique(platemap_df$row), decreasing = TRUE)),
    col = factor(
      col,
      levels = sort(unique(platemap_df$col))
    )
  )
#get all plates that have been found to have weird z'factors
plates <- unique(platemap_df$data.plate_id)
#print platemaps
lapply(plates, print_platemap, platemap_df = platemap_df)
```

\newpage

## Average Intra-Assay %CV

Average Intra-Assay %CV is measure on a $[0, +\inf]$ scale. A higher Average%CV indicates a higher level of variability in the assay. It is calculated by taking the mean of all Intra-Assay %CVs over all conditions of an assay. Intra-Assay %CV is calculated for each condition in an assay by dividing the standard deviation of its signals by the mean of its signals.

[Further reading.](https://toptipbio.com/calculate-coefficient-variation-cv/)

Unlike Z'Factor, Average Intra-Assay %CV does not have a built-in cutoff. For this project, we will collect Average%CV's for all assays and calculate their quantile outlier bounds. This will serve as a cutoff.


```{r cvcutoff}
cvcutoff_tab <- alldf %>%
  select(assay_type, cv_cutoff) %>%
  distinct()
names(cvcutoff_tab) <- c("Assay Type", "Summary %CV Cutoff")
kable(cvcutoff_tab)
```

```{r cvs, out.width = "70%"}
cvplot <- alldf %>%
  select(experiment_id,
         experiment_type,
         assay_type,
         start_date,
         summary_cv,
         cv_cutoff) %>%
  arrange(assay_type, experiment_id) %>%
  distinct() %>%
  mutate(
    qc_flag = case_when(summary_cv > cv_cutoff ~ "High Summary %CV", TRUE ~ "Passed QC"),
    qc_flag = factor(qc_flag, levels = c("Passed QC", "High Summary %CV"))
  ) %>%
  ggplot(aes(x = assay_type, y = summary_cv)) +
  geom_boxplot(outliers = FALSE) +
  geom_quasirandom(size = 3,
                   alpha = .6,
                   aes(color = experiment_id, shape = qc_flag)) +
  scale_color_viridis_d(end = .9) +
  theme_bw() +
  labs(
    x = "Assay Type",
    y = "Summary %CV",
    color = "Experiment ID",
    shape = "Summary %CV",
    title = "%CV"
  ) +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    text = element_text(family = "serif")
  )

cvplot 
```
```{r cv_outliers, fig.height = 6, fig.width = 8}
cv_outlier_df <- alldf %>%
  filter(summary_cv > cv_cutoff) %>%
  mutate(
    nice_label = paste(assay_type, "Exp", experiment_id),
    nice_ctrl = case_when(
      ctrl == "100% control" ~ "100%\ncontrol",
      ctrl == "0% control" ~ "0%\ncontrol",
      ctrl == "control compound" ~ "control\ncompound",
      TRUE ~ ctrl
    ),
    #TODO: rename exp_cv_result and plate_cv_result columns-- they're confusing
    summary_cv_result = case_when(assay_type == "Screen" ~ exp_cv_result,
                                  TRUE ~ plate_cv_result)
  )

cv_plot <- ggplot(cv_outlier_df, aes(x = coi_lab, y = data.result)) +
  facet_wrap(~ nice_label, scales = "free") +
  geom_boxplot(outliers = FALSE) +
  geom_quasirandom(size = 3, alpha = .5, aes(color = summary_cv_result)) +
  scale_color_viridis_c(end = .8, option = "rocket", direction = -1) +
  # scale_color_gradient2(high = "#7E98AB", mid = "#841E5AFF", low = "#F06043FF",  midpoint = 0.5, na.value = "#000004FF") +
  theme_bw() +
  labs(
    title = "Raw Signal for Average%CV Outliers",
    y = "Raw RLU",
    x = "Compound",
    caption = "High %CV by compound => high variability relative to mean.",
    color = "%CV"
  ) +
  theme(legend.position = "bottom",
        text = element_text(family = "serif"),
        axis.text.x = element_text(angle=90, hjust=1))
cv_plot
```

Experiment 680021 appears to have high variability within all compounds. Especially of note is the apparently high variation in the condition R1881, which served as our 100% control. Two of the plates (in this project, screens have technical replicates across plates) in this experiment, specifially 1496 and 1497, were also flagged for Z'Factors lower than 0.

\newpage

# Initial Screen

The purpose of the initial screen was to designate "hit compounds," which would then move to the next phase of testing.

This was a viability assay, meaning that low RLU indicates cell death.

In this project, screens have technical replicates across plates.

In the following plots, horizontal lines represent hit designation cutoffs at 3-9 standard deviations away from the mean of the 100% control. Lower lines serve as stricter cutoffs for designating hits.

Z'Factor is calculated relative to 0% control condition.

In total, `r nrow(unique(alldf[grepl("SD hit", alldf$scr_hit), "coi"]))` had an average percent control lower than that of the 100% control - 3SD. This represents `r round(nrow(unique(alldf[grepl("SD hit", alldf$scr_hit), "coi"]))/nrow(unique(alldf[alldf$assay_type == "Screen" & alldf$ctrl == "sample", "coi"]))*100, 2)`% of the total number of compounds tested.

```{r initial_screen_plots, results = "asis", warning = FALSE}


all_cois <- unique(alldf$coi)
ctrls <- c(ctrl0, ctrl100, all_cois[grepl("VPC|VCP", all_cois)], "Enzalutamide")
ordered_cois <- c(ctrls, sort(str_remove(all_cois[!(all_cois %in% ctrls)], "MCULE-")))

screen <- alldf %>%
  filter(assay_type == "Screen") %>%
  #TODO: remove this-- this isn't helpful for plotting
    #just use mcule-xxxxxxxx for tables
  mutate(
    coi_lab = str_remove(coi, "MCULE-"),
    coi_lab = factor(coi_lab, levels = ordered_cois),
    plotter_zfactor = case_when(ctrl == "control compound" ~ NA, TRUE ~ summary_zfactor)
  )
#get color breaks for zfactor scale
color_break_range <- range(screen$plotter_zfactor[screen$plotter_zfactor > -Inf], na.rm = TRUE)
color_quantiles <- unname(quantile(color_break_range))
color_breaks <- sort(c(0, round(color_quantiles, 2)))

colors <- color_breaks %>%
  as.data.frame() %>%
  mutate(
    color = case_when(
      #TODO: don't hard code these numbers
      color_breaks >= .3 ~ "#2D1160FF",
      color_breaks < .3 &
        color_breaks >= -1.5 ~ "#B63679FF",
      TRUE ~ "#FEAF77FF"
    )
  ) %>%
  select(color) %>%
  as.list()

#calculate 100% control median
ctrl100_results <- as.list(screen[screen$ctrl == "100% control", "normed_results"])$normed_results
ctrl100_med <- median(ctrl100_results, na.rm = TRUE)
#calculate 100% control quantile outlier bound
ctrl100_bound <- quantile(ctrl100_results, probs = .25)[[1]] - 1.5*IQR(ctrl100_results)

#designate hits in a dataframe
meds <- screen %>%
  filter(ctrl == "sample") %>%
  group_by(coi, short_mcule_lab, ctrl) %>%
  summarize(min_fc = min(fc_ctrl100),
            #get minimum plate z'factor for each mcule
            min_plate_zprime = min(plate_zprime),
            mean_rel_rlu = mean(normed_results),
            sd_rel_rlu = sd(normed_results),
            med_rel_rlu = median(normed_results),
            max_rel_rlu = max(normed_results),
            zfac100 = mean(summary_zfactor100)) %>%
  mutate(scr_hit = case_when(max_rel_rlu < ctrl100_bound & min_plate_zprime > 0 ~ "quantile outlier hit",
                             max_rel_rlu < ctrl100_bound ~ "rerun this compound")) %>%
  ungroup() %>%
  arrange(med_rel_rlu)

plot_hits <- meds %>%
  filter(scr_hit %in% c("quantile outlier hit", "rerun this compound"))

screenplot <- ggplot(data = screen, aes(x = short_mcule_lab, y = normed_results)) +
  geom_boxplot(data = screen, aes(x = short_mcule_lab, y = normed_results)) +
  geom_point(data = screen, aes(x = short_mcule_lab, y = normed_results, color = plotter_zfactor), alpha = .6) +
  theme_bw() +
  labs(
    title = paste("Screening Experiments", paste(unique(screen$experiment_id), collapse = ", ")),
    x = "Compound",
    y = "Percent Control RLU",
    color = "ZFactor"
  ) +
  scale_color_gradientn(
    colors = colors$color,
    breaks = color_breaks,
    limits = c(
      min(screen$plotter_zfactor[screen$plotter_zfactor > -Inf], na.rm = TRUE),
      max(screen$plotter_zfactor, na.rm = TRUE)
    )
  ) +
  new_scale_color() +
  geom_point(data = plot_hits, size = 4, alpha = .4, aes(x = short_mcule_lab, y = med_rel_rlu, color = scr_hit)) + 
  scale_color_viridis_d(begin = .65) +
  geom_hline(yintercept = ctrl100_bound, color = "#FEAF77FF", linewidth = 1.5) +
  labs(color = "Hit") +
  # scale_color_gradient2(low = "red", mid = "purple", high = "blue", midpoint = -1, na.value = "black", limits = c(min(screen$summary_zfactor[screen$summary_zfactor > -Inf], na.rm = TRUE), max(screen$summary_zfactor, na.rm = TRUE))) +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.key.height = unit(.8, "cm"),
    legend.key.width = unit(.3, "cm"),
    legend.text = element_text(size = 7),
    plot.margin = unit(c(.1, .1, .1, .1), "cm"),
    axis.text = element_text(size = 8),
    text = element_text(family = "serif")
  ) +
  ylim(c(0, max(screen$normed_results, na.rm = TRUE))) +
  #label cutoff line
  geom_label(
    x = as.numeric(max(unique(screen$short_mcule_lab), na.rm = TRUE)),
    y = ctrl100_bound,
    hjust = 1.2,
    vjust = -.6,
    label = paste0(
      "100% Control Quantile Outlier Bound"
      #TODO: add this back
      # ,
      # n_hits,
      # " FC hits ~ ",
      # round(hit_rate, 2),
      # "% hit rate"
    )
  )
screenplot
```
\newpage

see fold change plot

```{r fcplot, fig.width = 10}
#get x hits to label on plot
tier_1_n <- 13
tier_2_n <- 20
#TODO: make this an input parameter to ur script
#make an unsummarized dataframe to add boxplots
unsum <- screen %>%
  filter(ctrl == "sample") %>%
  mutate(short_mcule_lab = factor(as.numeric(str_extract(coi, "[:digit:]{3}$")), ordered = TRUE))
  
  
# summarize fc by medians
meds <- unsum %>%
  group_by(coi, short_mcule_lab, ctrl) %>%
  summarize(min_fc = min(fc_ctrl100),
            #get minimum plate z'factor for each mcule
            min_plate_zprime = min(plate_zprime),
            med_fc = median(fc_ctrl100),
            mean_rel_rlu = mean(normed_results),
            sd_rel_rlu = sd(normed_results),
            mean_rel_rlu = mean(normed_results),
            sd_rel_rlu = sd(normed_results),
            fc = median(fc_ctrl100),
            zfac100 = mean(summary_zfactor100)) %>%
  mutate(zfac100 = case_when(ctrl == "100% control" ~ NA,
                             TRUE ~ zfac100)) %>%
  ungroup() %>%
  arrange(fc)

#calculate median r1881
ctrl100_df <- screen %>%
  filter(ctrl == "100% control")
med_ctrl100 <- median(ctrl100_df$fc_ctrl100, na.rm = TRUE)
#calculate median r1881 + 3sd
sd_ctrl100 <- sd(ctrl100_df$fc_ctrl100, na.rm = TRUE)
med_3sd_ctrl100 <- med_ctrl100 + sd_ctrl100

n_hits <- nrow(meds[meds$fc > med_3sd_ctrl100, ])
hit_rate <- n_hits / nrow(meds) * 100

#designate hits
hit_designator <- meds %>%
  filter(min_plate_zprime > 0 & min_fc > med_3sd_ctrl100)
hit_designator <- hit_designator %>%
  mutate(look = row_number(),
         fc_hit = case_when(row_number() > nrow(hit_designator) - tier_1_n + 1 ~ "Tier 1",
                            row_number() > nrow(hit_designator) - tier_2_n + 1 ~ "Tier 2",
                            TRUE ~ NA),
         fc_hit = factor(fc_hit, levels = c("Tier 1", "Tier 2", NA)))
#merge hit designation back into meds (medians) dataframe
meds2 <- merge(meds, hit_designator, on = short_mcule_lab, all.x = TRUE)

labs_df <- hit_designator %>% filter(fc_hit %in% c("Tier 1", "Tier 2"))

segmenter <- unsum %>%
  pivot_longer(cols = fc_ctrl100) %>%
  select(short_mcule_lab, name, value) %>%
  arrange(short_mcule_lab) %>%
  group_by(short_mcule_lab) %>%
  mutate(max_or_min = case_when(value == max(value) ~ "max",
                                value == min(value) ~ "min",
                                TRUE ~ NA)) %>%
  filter(!(value < max(value) & value > min(value))) %>%
  pivot_wider(id_cols = short_mcule_lab, names_from = max_or_min, values_from = value)

# geom_segment(data = segmenter, aes(x = xval, y = Left, xend = xval, yend = Right)) +
#   geom_point(size = 3, alpha = .2, data = vol, aes(x = xval, y = value)) 

fcplot <- ggplot() +
  geom_segment(data = segmenter, aes(x = short_mcule_lab, y = max, xend = short_mcule_lab, yend = min)) +
  geom_point(data = unsum, aes(x = short_mcule_lab, y = fc_ctrl100), alpha = .3, size = 2) +
  geom_point(data = meds2, aes(x = short_mcule_lab, y = fc, color = fc_hit), alpha = .5, size = 3) +
  theme_bw() +
  #label hits
  # geom_label(data = labs_df, aes(x = short_mcule_lab, y = fc, label = short_mcule_lab), size = 3, vjust = 1) +
  geom_hline(
    yintercept = med_3sd_ctrl100,
    color = "maroon",
    linewidth = 1.3,
    linetype = 4
  ) +
  #label cutoff line
  geom_label(
    x = max(unsum$short_mcule_lab),
    y = med_3sd_ctrl100,
    label = paste0(
      "Median+3SD 100% Control\n",
      n_hits,
      " FC hits ~ ",
      round(hit_rate, 2),
      "% hit rate"
    ),
    hjust = -1
    # ,
    # hjust = 1,
    # vjust = 1.2
  ) +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    text = element_text(family = "serif")
  ) +
  labs(title = "Fold Change Hits", subtitle = paste0("Tier 1 has an n of ", tier_1_n, ", Tier 2 has an n of ", (tier_2_n - tier_1_n)), y = "Fold-Reduction of Luciferase", x = "Compound by Number", color = "Hits") +
  scale_color_manual(values = c("Tier 1" = "dodgerblue", "Tier 2" = "orange2", NA),
                     na.value = "black")
  # paletteer::scale_color_paletteer_d("wesanderson::GrandBudapest1")

fcplot
ggsave(paste0(here("graphs"), "/fold_change_hit_designator.png"), plot = fcplot)
```

accompanying table

```{r}
tab1 <- meds2 %>%
  select(coi, short_mcule_lab, ctrl, fc_hit, med_fc, fc, min_fc, min_plate_zprime, mean_rel_rlu, sd_rel_rlu) %>%
  mutate(fc_cutoff = med_3sd_ctrl100) %>%
  arrange(fc_hit, coi) %>%
  filter(med_fc > fc_cutoff)
kable(tab1)

```


## Designated Hits

```{r exps_w_hits}
exps_w_hits <- alldf %>%
  filter(!grepl("not", scr_hit))
```

```{r summary_hit_tab}
# hit_tab0 <- alldf %>%
#   filter(assay_type == "Screen") %>%
#   group
# 
# hit_tab <- exps_w_hits %>%
#   select(experiment_id, start_date, exp_cv, exp_zprime,
#          coi_lab, coi_dose, scr_hit) %>%
#   distinct() %>%
#   group_by(scr_hit) %>%
#   summarise(mcules = n())
# names(hit_tab) <- c("Cutoff Hit", "Number of Compounds")
# kable(hit_tab, digits = 3)
# hit_tab
#TODO: make this like.... more of a program not me just looking at this and saying it looks good
```



how many 9sd hits for each experiment? and see z'factors for each

```{r hitplots, warning = FALSE}
forplot <- alldf %>%
  filter(experiment_id %in% exps_w_hits$experiment_id) %>%
  filter(scr_hit == "9SD hit" | coi == "Enzalutamide" | grepl("VPC|VCP", coi) | ctrl != "sample") %>%
  mutate(
    ctrl_lab = case_when(grepl("control", ctrl) ~ "control",
                         TRUE ~ "sample")
  )
hplot <- ggplot(data = forplot, aes(x = coi_lab, y = normed_results)) +
  facet_grid(cols = vars(experiment_id), scales = "free_x") +
  geom_boxplot(outliers = FALSE) +
  geom_quasirandom(size = 2, alpha = .6, aes(color = ctrl_lab)) +
  theme_bw() +
  theme(text = element_text(family = "serif"),
        legend.position = "none",
        axis.text.x = element_text(
        angle = 90,
        hjust = 1,
        size = 7
      )) +
  scale_color_paletteer_d("nord::algoma_forest") +
  ylim(c(0, max(forplot$normed_results))) +
  labs(x = "Compound",
       y = "Percent Control RLU",
       title = "Designated Hits from Initial Screen")
hplot
```


```{r hit_tab}
hit_tab <- exps_w_hits %>%
  filter(scr_hit == "9SD hit") %>%
  select(experiment_id, start_date, exp_cv, exp_zprime,
         coi_lab, coi_dose, scr_hit) %>%
  distinct() %>%
  arrange(start_date, coi_lab) %>%
  kable(digits = 3)
hit_tab
```


\newpage

# Dose Response

The purpose of this assay was to further investigate our hits by modelling their dose responses.

This was a viability assay, meaning that low RLU indicates cell death.

Response is normalized to control using this formula:



The following table includes all compounds that achieved 50% (absolute and relative) inhibition without extrapolating. Compounds with outlier RSE's are excluded.

```{r drc_good_ones, results = "asis"}
mcules_drc_ed <- stats  %>% 
  filter(assay_type == "Dose Response Curve") %>%
  filter(ctrl == "sample") %>%
  select(experiment_id, start_date, data.plate_id, coi, abs_ec50) %>%
  distinct()

#TODO ^ find a better way to do this
kable(best_ec50_drc, digits = 3)
```

`r nrow(best_ec50_drc)` molecules of the `r nrow(mcules_drc_ed)` tested (`r nrow(best_ec50_drc)/nrow(mcules_drc_ed)*100`) produced quality EC50s.

\newpage

```{r drcs, results = "asis", warning = FALSE}
#TODO: color code all mcules, ctrls
#get all the cois that have dose response curves
drcs <- alldf %>%
  filter(assay_type == "Dose Response Curve")


coi_list <- drcs %>%
  filter(ctrl == "sample") %>%
  select(coi) %>%
  distinct() %>%
  #this is how u get it to be a cute vector within the dplyr chunk....
  as.vector() %>%
  unname() %>%
  unlist() %>%
  sort()

lapply(coi_list, print_drcs, drcs, "Raw RLU")

#TODO: add comment about dose
```

\newpage

# AR Polar Screen
 

This fluorescence polarization assay is used to investigate how well our hit compounds bind to the desired target site.

Response is normalized to control using this formula:



The following table includes all compounds that achieved 50% relative binding without extrapolating (we have a reliable relative EC50).


```{r pb_good_ones, results = "asis"}
mcules_drc_ed <- stats  %>% 
  filter(assay_type == "Polar Binding") %>%
  filter(ctrl == "sample") %>%
  select(experiment_id, start_date, experiment_name, data.plate_id, coi, abs_ec50) %>%
  distinct()

kable(best_ec50_pb, digits = 3)
#TODO ^ find a better way to do this

```


`r nrow(best_ec50_pb)` molecules of the `r nrow(mcules_drc_ed)` tested (`r nrow(best_ec50_pb)/nrow(mcules_drc_ed)*100`) produced quality relative and absolute EC50s.

\newpage

```{r polar_binding_drcs, results = "asis", warning = FALSE}
#TODO: color code for drugs, not experiments?
drc_exps <- alldf %>%
  filter(assay_type == "Polar Binding") %>%
  #TODO: can i put this factorization earlier in the script?( in the data cleaning script)? or will it mess everythign up?
  mutate(ctrl = factor(ctrl, levels = c("sample", "control compound", "0% control", "100% control")))
coi_list <- drc_exps %>%
  filter(ctrl == "sample") %>%
  select(coi) %>%
  distinct() %>%
  #this is how u get it to be a cute vector within the dplyr chunk....
  as.vector() %>%
  unname() %>%
  unlist() %>%
  sort()

lapply(coi_list, print_drcs, drc_exps, raw_plot_ylab = "Polarization (mP)")
```


```{r table_output}
#output initial screen stats
initial_screen_hits <- alldf %>%
  filter(assay_type == "Screen") %>%
  select(experiment_name, experiment_id, start_date, coi, coi_dose, exp_zprime, exp_cv, exp_mean_ctrl0, exp_sd_ctrl0, exp_mean_ctrl100, exp_sd_ctrl100, exp_mean_res, exp_mean_pc, scr_hit) %>%
  distinct()
names(initial_screen_hits) <- c("Experiment Name", "Experiment ID", "Start Date", "Compound", "Dose", "Experiment Z'Factor", "Average Intra-Experiment %CV", "Experiment Mean 0% Control (DMSO)", "Experiment SD 0% Control (DMSO)", "Experiment Mean 100% Control (R1881)", "Experiment SD 100% Control (DMSO)", "Mean Raw RLU", "Mean Percent Control", "Hit?")
#TODO: figure out how to install rJava
# library(xlsx)
# xlsx::write.xlsx(initial_screen_hits, file = here("data", "sandbox_r1_summary-stats.xlsx"), sheetName = "Initial Screen")
write_csv(initial_screen_hits, here("data", "sandbox_r1_summary-stats_initial-screen.csv"))

#output dose response curve stats
drc_stats <- stats %>%
  filter(assay_type == "Dose Response Curve") %>%
  filter(ctrl %in% c("sample", "control compound")) %>%
  #add ec50 cis
  mutate(abs_ec50_ci = paste0("(", round(abs_ec50_lower, 2), ", ", round(abs_ec50_upper, 2)),
         rel_ec50_ci = paste0("(", round(rel_ec50_lower, 2), ", ", round(rel_ec50_upper, 2))) %>%
  select(experiment_name, experiment_id, exp_zprime, exp_cv, exp_mean_ctrl100, exp_sd_ctrl100, exp_mean_ctrl0, exp_sd_ctrl0, 
         #plate
         data.plate_id, plate_zprime, plate_cv, plate_mean_ctrl100, plate_sd_ctrl100, plate_mean_ctrl0, plate_sd_ctrl0,
         #compound
         coi, ctrl, n_dose_per_cmpnd_plate, 
         #drc
         does_it_drc, hill, min_val, max_val,
         abs_ec50, abs_ec50_ci,
         rel_ec50, rel_ec50_ci,
         extrapolated_rel_ec50, extrapolated_abs_ec50, rse, rse_cutoff) %>%
  distinct()

names(drc_stats) <- c("Experiment Name", "Experiment ID", "Experiment Z'Factor", "Average Intra-Experiment %CV", "Experiment Mean 100% Control", "Experiment SD 100% Control", "Experiment Mean 0% Control", "Experiment SD 0% Control", "Plate ID", "Plate Z'Factor", "Average Intra-Plate %CV", "Plate Mean 100% Control", "Plate SD 100% Control", "Plate Mean 0% Control", "Plate SD 0% Control", "Compound", "Control?", "Number of Doses", "Does it Model with drc()?", "Hill Slope", "Lower Asymptote", "Upper Asymptote", "Absolute EC50", "Absolute EC50 CI", "Relative EC50", "Relative EC50 CI", "Extrapolated Relative IC50?", "Extrapolated Absolute IC50?", "RSE", "RSE Cutoff")
write_csv(drc_stats, here("data", "sandbox_r1_summary-stats_drc_stats.csv"))

#output dose response curve stats
pb_stats <- stats %>%
  filter(assay_type == "Polar Binding") %>%
  filter(ctrl %in% c("sample", "control compound")) %>%
  #add ec50 cis
  mutate(abs_ec50_ci = paste0("(", round(abs_ec50_lower, 2), ", ", round(abs_ec50_upper, 2), ")"),
         rel_ec50_ci = paste0("(", round(rel_ec50_lower, 2), ", ", round(rel_ec50_upper, 2), ")")) %>%
  select(experiment_name, experiment_id, exp_zprime, exp_cv, exp_mean_ctrl100, exp_sd_ctrl100, exp_mean_ctrl0, exp_sd_ctrl0, 
         #plate
         data.plate_id, plate_zprime, plate_cv, plate_mean_ctrl100, plate_sd_ctrl100, plate_mean_ctrl0, plate_sd_ctrl0,
         #compound
         coi, ctrl, n_dose_per_cmpnd_plate, 
         #drc
         does_it_drc, hill, min_val, max_val,
         abs_ec50, abs_ec50_ci,
         rel_ec50, rel_ec50_ci,
         extrapolated_rel_ec50, extrapolated_abs_ec50, rse, rse_cutoff) %>%
  distinct()

names(pb_stats) <- c("Experiment Name", "Experiment ID", "Experiment Z'Factor", "Average Intra-Experiment %CV", "Experiment Mean 100% Control", "Experiment SD 100% Control", "Experiment Mean 0% Control", "Experiment SD 0% Control", "Plate ID", "Plate Z'Factor", "Average Intra-Plate %CV", "Plate Mean 100% Control", "Plate SD 100% Control", "Plate Mean 0% Control", "Plate SD 0% Control", "Compound", "Control?", "Number of Doses", "Does it Model with drc()?", "Hill Slope", "Lower Asymptote", "Upper Asymptote", "Absolute EC50", "Absolute EC50 CI", "Relative EC50", "Relative EC50 CI", "Extrapolated Relative EC50?", "Extrapolated Absolute EC50?", "RSE", "RSE Cutoff")
write_csv(pb_stats, here("data", "sandbox_r1_summary-stats_polar-binding_stats.csv"))

```




