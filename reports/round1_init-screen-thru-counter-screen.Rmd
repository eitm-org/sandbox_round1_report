---
title: "Sandbox Round 1"
author: "Abby Coleman"
date: "`r Sys.Date()`"
geometry: margin = 2cm
output: 
  pdf_document:
    toc: TRUE
    
header-includes:
  - \usepackage{titling}
  - \pretitle{\begin{center}
  - \includegraphics[width=1in,height=1in]{Ellison Medical Institute Logo_Bronze.png}\LARGE\\}
  - \posttitle{\end{center}}
  - \usepackage{fancyhdr}
  - \pagestyle{fancy}
  - \fancyhead[C]{Sandbox Round 1}
  - \fancyhead[L]{\includegraphics[width=0.5in]{Ellison Medical Institute Logo_Bronze.png}}
  - \fancyfoot[L]{Ellison Medical Institute}
  - \setlength{\headheight}{30.10677pt}
---

```{r setup, include=FALSE}
library(here)
library(pander)
library(ggplot2)
library(ggbeeswarm)
library(tidyverse)
library(kableExtra)
library(viridis)
library(paletteer)

source(here("R", "functions.R"))

knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      fig.align = "center")
```

  
# Overall Summary

```{r data_load}
#TODO: throw this into a script in the munge directory, functionalize, add tests

ctrl0 <- "DMSO"
ctrl100 <- "R1881"

screen <- readRDS(here("data", "screen_data.rds")) %>%
  unnest(cols = data, names_sep = ".") %>%
  select(
    study_name,
    study_rid,
    experiment_name,
    experiment_rid,
    experiment_id,
    experiment_type,
    assay_type,
    container,
    start_date,
    instrument,
    sop,
    data.plate_id,
    data.replicate_group,
    data.drug_name,
    data.drug_id,
    data.concentration,
    data.units,
    sample_id,
    data.well_id,
    data.result,
    data.plate_cv,
    data.plate_z_prime,
    data.norm_result
  ) %>%
  distinct()

drc <- readRDS(here("data", "drc_data.rds")) %>%
  unnest(cols = data, names_sep = ".") %>%
  select(
    study_name,
    study_rid,
    experiment_name,
    experiment_rid,
    experiment_id,
    experiment_type,
    assay_type,
    container,
    start_date,
    instrument,
    sop,
    data.plate_id,
    data.replicate_group,
    data.drug_name,
    data.drug_id,
    data.concentration,
    data.units,
    sample_id,
    data.well_id,
    data.result,
    data.plate_cv,
    data.plate_z_prime,
    data.norm_result
  ) %>%
  distinct()

binding <- readRDS(here("data", "binding_data.rds")) %>%
  unnest(cols = data, names_sep = ".") %>%
  select(
    study_name,
    study_rid,
    experiment_name,
    experiment_rid,
    experiment_id,
    experiment_type,
    assay_type,
    container,
    start_date,
    instrument,
    sop,
    data.plate_id,
    data.replicate_group,
    data.drug_name,
    data.drug_id,
    data.concentration,
    data.units,
    sample_id,
    data.well_id,
    data.result,
    data.plate_cv,
    data.plate_z_prime,
    data.norm_result
  ) %>%
  distinct()

#add dmso to binding
meta <- binding %>%
  select(
    study_name,
    study_rid,
    experiment_name,
    experiment_rid,
    experiment_id,
    experiment_type,
    assay_type,
    container,
    start_date,
    instrument,
    sop,
    sample_id,
    data.plate_id,
    data.replicate_group,
    data.well_id,
    data.result,
    data.plate_cv,
    data.plate_z_prime,
    data.norm_result
    ) %>%
  distinct() %>%
  mutate(data.drug_name = "DMSO",
         data.concentration = .1,
         data.units = "%")

ctrl_list <- c(ctrl0, ctrl100)
other_reagents <- c("FL AL Green", "AR  Screeining Buffer", "AR-LBD (GST)")

alldf <- bind_rows(screen, drc, binding, meta) %>%
  #first, designate controls and designate "compound of interest"
  #to do that, we have to nest by well (and keep all other columns outside of the nested part)
  group_by(
    data.well_id,
    study_name,
    study_rid,
    experiment_name,
    experiment_rid,
    experiment_id,
    experiment_type,
    assay_type,
    container,
    start_date,
    instrument,
    sop,
    data.plate_id,
    data.replicate_group,
    data.result,
    data.plate_cv,
    data.plate_z_prime,
    data.norm_result
  ) %>%
  nest() %>%
  mutate(
    coi = map(data, get_coi, ctrl_list, other_reagents),
    coi_dose = map2(data, coi, get_coi_concentration),
    ctrl = case_when(
      coi == ctrl0 ~ "0% control",
      coi == ctrl100 ~ "100% control",
      grepl("VPC|VCP|Enzalutamide", coi) ~ "control compound",
      coi == "what the " ~ "what the ",
      TRUE ~ "sample"
    )
  ) %>%
  unnest(cols = c(ctrl, coi, coi_dose)) %>%
  ungroup() %>%
  #plate 1498, 1499, 1500. rows f and g were mislabelled "r1881" when they should be blank wells
  mutate(coi = case_when(data.plate_id %in% c(1498, 1499, 1500) & grepl("F|G", data.well_id) ~ "blank well",
                         TRUE ~ coi),
         ctrl = case_when(data.plate_id %in% c(1498, 1499, 1500) & grepl("F|G", data.well_id) ~ "blank well",
                         TRUE ~ ctrl)) %>%
  #next, calculate mean and sd result for each replicate group
  group_by(experiment_id, data.plate_id, coi, coi_dose, ctrl) %>%
  mutate(
    plate_mean_res = mean(data.result, na.rm = TRUE),
    plate_sd_res = sd(data.result, na.rm = TRUE),
    plate_cv_result = (plate_sd_res / plate_mean_res) * 100
  ) %>%
  ungroup() %>%
  group_by(experiment_id, coi, coi_dose, ctrl) %>%
  mutate(
    exp_mean_res = mean(data.result, na.rm = TRUE),
    exp_sd_res = sd(data.result, na.rm = TRUE),
    exp_cv_result = (exp_sd_res / exp_mean_res) * 100
  ) %>%
  ungroup() %>%
  #use those to calculate plate %CV and zfactor
  group_by(data.plate_id) %>%
  mutate(
    plate_cv = mean(plate_cv_result, na.rm = TRUE),
    plate_mean_ctrl100 = mean(data.result[ctrl == "100% control"], na.rm = TRUE),
    plate_sd_ctrl100 = sd(data.result[ctrl == "100% control"], na.rm = TRUE),
    plate_mean_ctrl0 = mean(data.result[ctrl == "0% control"], na.rm = TRUE),
    plate_sd_ctrl0 = sd(data.result[ctrl == "0% control"], na.rm = TRUE),
    normed_results = (data.result - plate_mean_ctrl0) / (plate_mean_ctrl100 - plate_mean_ctrl0) *
      100
  ) %>%
  ungroup() %>%
  group_by(experiment_id) %>%
  mutate(
    exp_cv = mean(exp_cv_result, na.rm = TRUE),
    exp_mean_ctrl100 = mean(data.result[ctrl == "100% control"], na.rm = TRUE),
    exp_sd_ctrl100 = sd(data.result[ctrl == "100% control"], na.rm = TRUE),
    exp_mean_ctrl0 = mean(data.result[ctrl == "0% control"], na.rm = TRUE),
    exp_sd_ctrl0 = sd(data.result[ctrl == "0% control"], na.rm = TRUE)
  ) %>%
  ungroup() %>%
  mutate(
    plate_zfactor = 1 - (
      3 * (plate_sd_res + plate_sd_ctrl0) / (plate_mean_res - plate_mean_ctrl0)
    ),
    plate_zprime = 1 - (
      3 * (plate_sd_ctrl100 + plate_sd_ctrl0) / (plate_mean_ctrl100 - plate_mean_ctrl0)
    ),
    exp_zfactor = 1 - (3 * (exp_sd_res + exp_sd_ctrl0) / (exp_mean_res - exp_mean_ctrl0)),
    exp_zprime = 1 - (
      3 * (exp_sd_ctrl100 + exp_sd_ctrl0) / (exp_mean_ctrl100 - exp_mean_ctrl0)
    ),
    summary_zfactor = case_when(
      assay_type == "Screen" ~ exp_zfactor,
      assay_type == "Dose Response Curve" | assay_type == "Polar Binding" ~ plate_zfactor
    ),
    summary_zprime = case_when(
      assay_type == "Screen" ~ exp_zprime,
      assay_type == "Dose Response Curve" | assay_type == "Polar Binding" ~ plate_zprime
    ),
    summary_cv = case_when(
      assay_type == "Screen" ~ exp_cv,
      assay_type == "Dose Response Curve" | assay_type == "Polar Binding" ~ plate_cv
    ),
    assay_type = factor(assay_type, levels = c("Screen", "Dose Response Curve", "Polar Binding"))
  ) %>%
  #calculate cv cutoffs
  group_by(experiment_id, summary_cv, assay_type) %>%
  nest() %>%
  group_by(assay_type) %>%
  mutate(cv_cutoff = quantile(summary_cv, prob = .75) + 1.5 * IQR(summary_cv)) %>%
  unnest(cols = c(data)) %>%
  ungroup() %>%
  #designate hits
    #group by replicate group (over experiments)
  group_by(experiment_id, coi, coi_dose, ctrl) %>%
  mutate(exp_mean_pc = mean(normed_results, na.rm = TRUE)) %>%
  group_by(experiment_id) %>%
  mutate(exp_mean_ctrl100_pc = mean(normed_results[ctrl == "100% control"], na.rm = TRUE),
         exp_sd_ctrl100_pc = sd(normed_results[ctrl == "100% control"], na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(scr_hit = case_when(assay_type == "Screen" & exp_mean_pc < (exp_mean_ctrl100_pc - 3*exp_sd_ctrl100_pc) & ctrl == "sample" ~ "hit",
                             assay_type == "Screen" ~ "not a hit",
                             assay_type != "Screen" ~ "not a screen"),
         scr_hit = factor(scr_hit, levels = c(
           "not a hit", "hit", "not a screen")),
         #calculate fold change from 0% control
         fc_ctrl0 = data.result/plate_mean_ctrl0,
         #calculate separation from 100% control
         sep_ctrl100 = case_when(assay_type == "Screen" ~ 1 - (3 * (exp_sd_ctrl100 + exp_sd_res) / (exp_mean_ctrl100 - exp_mean_res)),
                                 assay_type %in% c("Dose Response Curve", "Polar Binding") ~ 1 - (3 * (plate_sd_ctrl100 + plate_sd_res) / (plate_mean_ctrl100 - plate_mean_res))))


#make a nice version of the MCULE-XXXXXXX labels for plots
all_cois <- unique(alldf$coi)
ctrls <- c(ctrl0, ctrl100, "Enzalutamide", all_cois[grepl("VPC|VCP", all_cois)])
ordered_cois <- c(ctrls, sort(str_remove(all_cois[!(all_cois %in% ctrls)], "MCULE-")))
alldf <- alldf %>%
  mutate(
    coi_lab = str_remove(coi, "MCULE-"),
    coi_lab = factor(coi_lab, levels = ordered_cois)
  )
#TODO: the ctrl column now includes designation of "control compounds" for enz and vpc-- make sure to make corresponding edits in ur code (to avoid redundancy)
```


\newpage

# Quality Control

## Overall Summary

explain how zprimes, cvs are calculated for screens, drcs

```{r qc_tab1}
qctab <- alldf %>%
  mutate(
    plate_zprime = cell_spec(
      round(plate_zprime, 3),
      color = case_when(plate_zprime < 0 ~ "white", TRUE ~ "black"),
      background = case_when(plate_zprime < 0 ~ "#A96D4B", TRUE ~ "white")
    ),
    summary_cv = cell_spec(
      round(summary_cv, 3),
      color = case_when(summary_cv > cv_cutoff ~ "white", TRUE ~ "black"),
      background = case_when(summary_cv > cv_cutoff ~ "#A96D4B", TRUE ~ "white")
    )
  ) %>%
  select(experiment_id,
         data.plate_id,
         experiment_type,
         assay_type,
         start_date,
         plate_zprime,
         summary_cv) %>%
  distinct() %>%
  arrange(assay_type, experiment_id)
names(qctab) <- c(
  "Experiment ID",
  "Plate ID",
  "Experiment Type",
  "Assay Type",
  "Start Date",
  "Plate Z'Factor",
  "Summary Percent CV"
)
kable(qctab, digits = 3)
```

check cv calculation

\newpage

## Z'Factor


```{r qcbox, out.width = "60%"}
qcplot <- alldf %>%
  select(experiment_id,
         experiment_type,
         assay_type,
         start_date,
         plate_zprime) %>%
  arrange(assay_type, experiment_id) %>%
  distinct() %>%
  mutate(
    qc_flag = case_when(plate_zprime < 0 ~ "Z'Factor < 0", TRUE ~ "Passed QC"),
    qc_flag = factor(qc_flag, levels = c("Passed QC", "Z'Factor < 0"))
  ) %>%
  ggplot(aes(x = assay_type, y = plate_zprime)) +
  geom_boxplot(outliers = FALSE) +
  geom_quasirandom(size = 3,
                   alpha = .6,
                   aes(color = experiment_id, shape = qc_flag)) +
  scale_color_viridis_d(end = .9) +
  theme_bw() +
  labs(
    x = "Assay Type",
    y = "Plate Z'Factor",
    color = "Experiment ID",
    shape = "QC Flag",
    title = "Z'Factors by Plate"
  ) +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    text = element_text(family = "serif")
  )

qcplot 
```

### Z'Factors < 0

```{r zprime, fig.height = 6, fig.width = 8}
zplot <- alldf %>%
  filter(plate_zprime < 0) %>%
  mutate(
    nice_label = paste(assay_type, "Exp", experiment_id, "Plate", data.plate_id),
    nice_ctrl = case_when(
      ctrl == "100% control" ~ "100%\ncontrol",
      ctrl == "0% control" ~ "0%\ncontrol",
      TRUE ~ ctrl
    )
  ) %>%
  ggplot(aes(x = nice_ctrl, y = data.result)) +
  facet_wrap(~ nice_label, scales = "free") +
  geom_boxplot(outliers = FALSE) +
  geom_quasirandom(size = 3, alpha = .5, aes(color = coi)) +
  scale_color_viridis_d(guide = "none", end = .8) +
  # scale_color_gradient2(high = "#7E98AB", mid = "#841E5AFF", low = "#F06043FF",  midpoint = 0.5, na.value = "#000004FF") +
  theme_bw() +
  labs(
    title = "Normalized Results for Z'Factor Outliers",
    y = "Raw RLU",
    x = "Control",
    caption = "note differences in scale",
    color = "Z Factor"
  ) +
  theme(text = element_text(family = "serif"))
zplot
```

\newpage

Platemaps for Z'Factors < 0:

```{r platemaps, results = "asis", width.out = "30%"}
platemap_df <- alldf %>%
  filter(plate_zprime < 0) %>%
  mutate(
    well = str_extract(data.well_id, "[:alpha:][:digit:]{2}"),
    col = str_extract(well, "[:digit:]{2}"),
    row = str_extract(well, "[:alpha:]")
  ) %>%
  select(experiment_id, col, row, data.result, summary_zfactor, coi, data.plate_id) %>%
  distinct()

platemap_df <- platemap_df %>%
  mutate(
    nice_coi = str_remove(coi, "\\-[:digit:]+"),
    row = factor(row, levels = sort(unique(platemap_df$row), decreasing = TRUE)),
    col = factor(
      col,
      levels = sort(unique(platemap_df$col))
    )
  )

for (plate in unique(platemap_df$data.plate_id)) {
  exp <- unique(platemap_df[platemap_df$data.plate_id == plate, "experiment_id"])[[1]]
  cat("#### ", plate, " Platemap")
  cat("\n")
  forplot_df <- platemap_df %>%
    filter(data.plate_id == plate)
  plate_plot <- ggplot(data = forplot_df, aes(x = col, y = row, fill = data.result)) +
    geom_tile(color = "black", linewidth = 1) +
    scale_fill_viridis_c(option = "magma") +
    geom_text(color = "white",
              size = 2,
              aes(label = nice_coi)) +
    coord_fixed() +
    labs(
      title = paste("Experiment", exp, ", Plate", plate),
      x = "Column",
      y = "Row",
      fill = "Raw RLU"
    ) +
    theme(text = element_text(family = "serif"))
  print(plate_plot)
  cat("\\newpage")
}

```

\newpage

## %CV

```{r cvcutoff}
cvcutoff_tab <- alldf %>%
  select(assay_type, cv_cutoff) %>%
  distinct()
names(cvcutoff_tab) <- c("Assay Type", "Summary %CV Cutoff")
kable(cvcutoff_tab)
```

```{r cvs, out.width = "70%"}
cvplot <- alldf %>%
  select(experiment_id,
         experiment_type,
         assay_type,
         start_date,
         summary_cv,
         cv_cutoff) %>%
  arrange(assay_type, experiment_id) %>%
  distinct() %>%
  mutate(
    qc_flag = case_when(summary_cv > cv_cutoff ~ "High Summary %CV", TRUE ~ "Passed QC"),
    qc_flag = factor(qc_flag, levels = c("Passed QC", "High Summary %CV"))
  ) %>%
  ggplot(aes(x = assay_type, y = summary_cv)) +
  geom_boxplot(outliers = FALSE) +
  geom_quasirandom(size = 3,
                   alpha = .6,
                   aes(color = experiment_id, shape = qc_flag)) +
  scale_color_viridis_d(end = .9) +
  theme_bw() +
  labs(
    x = "Assay Type",
    y = "Summary %CV",
    color = "Experiment ID",
    shape = "Summary %CV",
    title = "%CV"
  ) +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    text = element_text(family = "serif")
  )

cvplot 
```

\newpage

# Initial Screen

```{r initial_screen_plots, results = "asis", warning = FALSE}

 # %>%
 #    mutate(summary_zfactor = case_when(ctrl == "compound control" ~ NA,
 #                                       TRUE ~ summary_zfactor))

all_cois <- unique(alldf$coi)
ctrls <- c(ctrl0, ctrl100, all_cois[grepl("VPC|VCP", all_cois)], "Enzalutamide")
ordered_cois <- c(ctrls, sort(str_remove(all_cois[!(all_cois %in% ctrls)], "MCULE-")))
screen <- alldf %>%
  filter(assay_type == "Screen") %>%
  mutate(
    coi_lab = str_remove(coi, "MCULE-"),
    coi_lab = factor(coi_lab, levels = ordered_cois)
  )
#write list of experiments
exps <- screen %>%
  select(experiment_id, start_date) %>%
  distinct() %>%
  arrange(start_date) %>%
  distinct(experiment_id) %>%
  as.list()

color_break_range <- range(screen$summary_zfactor[screen$summary_zfactor > -Inf], na.rm = TRUE)
color_quantiles <- unname(quantile(color_break_range))
color_breaks <- sort(c(0, round(color_quantiles, 2)))

colors <- color_breaks %>%
  as.data.frame() %>%
  mutate(
    color = case_when(
      color_breaks >= .5 ~ "#2D1160FF",
      color_breaks < .5 &
        color_breaks >= -10 ~ "#B63679FF",
      TRUE ~ "#FEAF77FF"
    )
  ) %>%
  select(color) %>%
  as.list()

for (exp in exps$experiment_id) {
  cat("##", exp, "All Compounds")
  cat("\n")
  forplot <- screen %>%
    filter(experiment_id == exp)
  ctrl100 <- as.list(forplot[forplot$ctrl == "100% control", "normed_results"])$normed_results
  ctrl100_mean_3sd <- mean(ctrl100, na.rm = TRUE) - 3 * sd(ctrl100, na.rm = TRUE)
  screenplot <- ggplot(data = forplot, aes(x = coi_lab, y = normed_results)) +
    geom_boxplot() +
    geom_quasirandom(aes(color = summary_zfactor, shape = scr_hit), alpha = .6) +
    theme_bw() +
    labs(
      title = paste("Experiment", exp),
      x = "Compound",
      y = "Percent Control RLU",
      color = "ZFactor",
      shape = "Hit?"
    ) +
    scale_color_gradientn(
      colors = colors$color,
      breaks = color_breaks,
      limits = c(
        min(screen$summary_zfactor[screen$summary_zfactor > -Inf], na.rm = TRUE),
        max(screen$summary_zfactor, na.rm = TRUE)
      )
    ) +
    # scale_color_gradient2(low = "red", mid = "purple", high = "blue", midpoint = -1, na.value = "black", limits = c(min(screen$summary_zfactor[screen$summary_zfactor > -Inf], na.rm = TRUE), max(screen$summary_zfactor, na.rm = TRUE))) +
    theme(
      axis.text.x = element_text(
        angle = 90,
        hjust = 1,
        size = 7
      ),
      legend.key.height = unit(1, "cm"),
      legend.key.width = unit(.3, "cm"),
      legend.text = element_text(size = 7),
      plot.margin = unit(c(.1, .1, .1, .1), "cm"),
      axis.text = element_text(size = 8),
      text = element_text(family = "serif")
    ) +
    geom_hline(yintercept = ctrl100_mean_3sd) +
    ylim(c(0, max(forplot$normed_results, na.rm = TRUE)))
  print(screenplot)
  cat("\\newpage")
}
```
\newpage

## Designated Hits

```{r hitplots, warning = FALSE}
exps_w_hits <- alldf %>%
  filter(scr_hit == "hit")

forplot <- alldf %>%
  filter(experiment_id %in% exps_w_hits$experiment_id) %>%
  filter(scr_hit == "hit" | coi == "Enzalutamide" | grepl("VPC|VCP", coi) | ctrl != "sample") %>%
  mutate(
    ctrl_lab = case_when(grepl("control", ctrl) ~ "control",
                         TRUE ~ "sample")
  )
hplot <- ggplot(data = forplot, aes(x = coi_lab, y = normed_results)) +
  facet_grid(rows = vars(experiment_id), scales = "free_x") +
  geom_boxplot(outliers = FALSE) +
  geom_quasirandom(size = 2, alpha = .6, aes(color = ctrl_lab)) +
  theme_bw() +
  theme(text = element_text(family = "serif"),
        legend.position = "none",
        axis.text.x = element_text(
        angle = 90,
        hjust = 1,
        size = 7
      )) +
  scale_color_paletteer_d("nord::algoma_forest") +
  ylim(c(0, max(forplot$normed_results))) +
  labs(x = "Compound",
       y = "Percent Control RLU",
       title = "Designated Hits from Initial Screen")
hplot
```

COMPARE TO MICHAEL'S HITS!

\newpage

# Dose Response

```{r drcs, results = "asis"}
#TODO: color code all mcules, ctrls
#get all the cois that have dose response curves
drc_exps <- alldf %>%
  filter(assay_type == "Dose Response Curve")
coi_list <- drc_exps %>%
  filter(ctrl == "sample") %>%
  select(coi) %>%
  distinct() %>%
  #this is how u get it to be a cute vector within the dplyr chunk....
  as.vector() %>%
  unname() %>%
  unlist() %>%
  sort()

lapply(coi_list, get_raw_drc_plot, drc_exps)

#TODO: add comment about dose
```

\newpage

# Polar Binding

```{r polar_binding_drcs}
drc_exps <- alldf %>%
  filter(assay_type == "Dose Response Curve")
coi_list <- drc_exps %>%
  filter(ctrl == "sample") %>%
  select(coi) %>%
  distinct() %>%
  #this is how u get it to be a cute vector within the dplyr chunk....
  as.vector() %>%
  unname() %>%
  unlist() %>%
  sort()

lapply(coi_list, get_raw_drc_plot, drc_exps)

```



# Counter Screen

```{r polar_binding_drcs}
polar_exps <- alldf %>%
  filter(assay_type == "Polar Binding")

coi_list <- polar_exps %>%
  filter(ctrl == "sample") %>%
  select(coi) %>%
  distinct() %>%
  #this is how u get it to be a cute vector within the dplyr chunk....
  as.vector() %>%
  unname() %>%
  unlist() %>%
  sort()

lapply(coi_list, get_raw_drc_plot, polar_exps)
```
